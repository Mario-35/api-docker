"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.urlRequestToArgs=void 0;const constants_1=require("../constants"),odata_1=require("./odata"),message_1=require("./message"),_1=require("."),excludeColumn=["id"],urlRequestToArgs=async(e,s)=>{const t=e.request.url.includes("-debug-")||void 0!==s&&s.tab.includes("-debug-");if(void 0!==s&&s.tab){s.tab.replace("-debug-","").trim().split("&").forEach(e=>{const t=e.split("=");s[t[0]]=t[1]})}let r=unescape(e.request.url.replace("-debug-","")).replace("/Query","");const a=(s=>{if(e.request.url.includes(s+"=")){const e=r.split("$").filter(e=>e.startsWith(s))[0];return r=r.replace("$"+e,""),e.replace(s+"=","")}})("resultFormat");let o=r.split("?");const u=[],l=[];let n=0,i=0;(0,_1.addToLog)(e,"datas",e.request.body!={}?e.request.body:s&&s.datas?s.datas:null);try{const c={LOG:{},ENTITY_NAME:"",ENTITY_ID:void 0,PROPERTY_NAME:void 0,RELATION_NAME:void 0,value:!1,baseUrl:"",version:"",entities:[],odada:e.request.querystring&&o[1]?(0,odata_1.createQuery)(o[1].trim()):(0,odata_1.createQuery)("$top="+(process.env.APILIMIT?Number(process.env.APILIMIT):200)),debug:t,formatResult:r.includes("$value")?constants_1.formatsResult.TXT:"CSV"==a?constants_1.formatsResult.CSV:"TXT"==a?constants_1.formatsResult.TXT:constants_1.formatsResult.JSON,extras:s};if(o=o[0].replace("//","/").split("/").map(e=>e.trim()),o[0]=e.request.header.host&&""===o[0]?e.request.header.host:"error",o.forEach((e,s)=>{const t=(0,_1.getEntityNameFromString)(o[s]);t&&(u.push(constants_1._DBDATAS[t]),n=s,l.push(e.trim())),e.match(/v{1}\d\.\d/g)&&(i=s)}),n>0){const s=o[n].toUpperCase().match(/[0-9]/g),t=u.length-1,r=l[t]===o.slice(3)[0]?void 0:o.slice(3).filter(e=>!excludeColumn.includes(e))[0],a=!!r&&(u[0].relations&&Object.keys(u[0].relations).includes(r));void 0!==u[t]?(c.ENTITY_NAME=u[t].name,c.ENTITY_ID=null!==s?BigInt(s.join("")):-1===o[o.length-1].indexOf("(")?BigInt(0):void 0,c.PROPERTY_NAME=a?void 0:r,c.RELATION_NAME=a?r:void 0,c.baseUrl=(0,_1.getHostName)(e),c.version=o[i],c.entities=l,c.value=e.request.url.includes("/$value")):(0,message_1.message)("ERROR","Error")}else"createDB"==o[o.length-1]&&(c.ENTITY_NAME="createDB");return t&&Object.keys(c).forEach(e=>(0,message_1.message)("ENV",e,c[e])),c}catch(e){if(e instanceof Error)return void(0,message_1.message)("ERROR",e.message)}};exports.urlRequestToArgs=urlRequestToArgs;