"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PGVisitor=void 0;const odata_v4_literal_1=require("odata-v4-literal"),visitor_1=require("odata-v4-sql/lib/visitor");class PGVisitor extends visitor_1.Visitor{constructor(e={}){super(e),this.parameters=[],this.includes=[],this.parameters=[],this.type=visitor_1.SQLLang.PostgreSql}parameterObject(){return Object.assign({},this.parameters)}from(e){let t=`SELECT ${this.select} FROM ${e} WHERE ${this.where} ORDER BY ${this.orderby}`;return"number"==typeof this.limit&&(t+=" LIMIT "+this.limit),"number"==typeof this.skip&&(t+=" OFFSET "+this.skip),t}VisitExpand(e){e.value.items.forEach(e=>{const t=e.value.path.raw;let i=this.includes.filter(e=>e.navigationProperty==t)[0];i||(i=new PGVisitor(this.options),i.parameterSeed=this.parameterSeed,this.includes.push(i)),i.Visit(e),this.parameterSeed=i.parameterSeed})}toSnakeCase(e){return e&&e.match(/[A-Z]{2,}(?=[A-Z][a-z]+[0-9]*|\b)|[A-Z]?[a-z]+[0-9]*|[A-Z]|[0-9]+/g).map(e=>e.toLowerCase()).join("_")}VisitSelectItem(e,t){const i=e.raw.replace(/\//g,".");this.select+=`"${i}"`}VisitODataIdentifier(e,t){let i=e.value.name.split("__");i=i.map(this.toSnakeCase),i.length>1?this[t.target]+=`"${i[0]}"."${i[1]}"`:this[t.target]+=`"${i[0]}"`,t.identifier=e.value.name}VisitEqualsExpression(e,t){this.Visit(e.value.left,t),this.where+=" = ",this.Visit(e.value.right,t),this.options.useParameters&&null==t.literal?this.where=this.where.replace(/= \:\d$/,"IS NULL").replace(new RegExp(`\\? = "${t.identifier}"$`),`"${t.identifier}" IS NULL`):"NULL"==t.literal&&(this.where=this.where.replace(/= NULL$/,"IS NULL").replace(new RegExp(`NULL = "${t.identifier}"$`),`"${t.identifier}" IS NULL`))}VisitNotEqualsExpression(e,t){this.Visit(e.value.left,t),this.where+=" <> ",this.Visit(e.value.right,t),this.options.useParameters&&null==t.literal?this.where=this.where.replace(/<> \:\d$/,"IS NOT NULL").replace(new RegExp(`\\? <> "${t.identifier}"$`),`"${t.identifier}" IS NOT NULL`):"NULL"==t.literal&&(this.where=this.where.replace(/<> NULL$/,"IS NOT NULL").replace(new RegExp(`NULL <> "${t.identifier}"$`),`"${t.identifier}" IS NOT NULL`))}VisitLiteral(e,t){if(this.options.useParameters){const i=odata_v4_literal_1.Literal.convert(e.value,e.raw);t.literal=i,this.parameters.push(i),this.where+=":"+(this.parameters.length-1)}else this.where+=t.literal=visitor_1.SQLLiteral.convert(e.value,e.raw)}VisitInExpression(e,t){this.Visit(e.value.left,t),this.where+=" IN (",this.Visit(e.value.right,t),this.where+=":list)"}VisitArrayOrObject(e,t){if(this.options.useParameters){const i=e.value.value.items.map(e=>"number"===e.value?parseInt(e.raw,10):e.raw);t.literal=i,this.parameters.push(i),this.where+=":"+(this.parameters.length-1)}else this.where+=t.literal=visitor_1.SQLLiteral.convert(e.value,e.raw)}VisitMethodCallExpression(e,t){const i=e.value.method,s=e.value.parameters||[];switch(i){case"contains":if(this.Visit(s[0],t),this.options.useParameters){const e=odata_v4_literal_1.Literal.convert(s[1].value,s[1].raw);this.parameters.push(""+e),this.where+=" ~* :"+(this.parameters.length-1)}else this.where+=` ~* '${visitor_1.SQLLiteral.convert(s[1].value,s[1].raw).slice(1,-1)}'`;break;case"endswith":if(this.Visit(s[0],t),this.options.useParameters){const e=odata_v4_literal_1.Literal.convert(s[1].value,s[1].raw);this.parameters.push("%"+e),this.where+=" LIKE :"+(this.parameters.length-1)}else this.where+=` ILIKE '%${visitor_1.SQLLiteral.convert(s[1].value,s[1].raw).slice(1,-1)}'`;break;case"startswith":if(this.Visit(s[0],t),this.options.useParameters){const e=odata_v4_literal_1.Literal.convert(s[1].value,s[1].raw);this.parameters.push(e+"%"),this.where+=" ILIKE :"+(this.parameters.length-1)}else this.where+=` ILIKE '${visitor_1.SQLLiteral.convert(s[1].value,s[1].raw).slice(1,-1)}%'`;break;case"substring":this.where+="SUBSTR(",this.Visit(s[0],t),this.where+=", ",this.Visit(s[1],t),this.where+=" + 1",s[2]?(this.where+=", ",this.Visit(s[2],t)):(this.where+=", CHAR_LENGTH(",this.Visit(s[0],t),this.where+=")"),this.where+=")";break;case"substringof":const e=/:\d+$/g;if(this.Visit(s[1],t),this.where.match(e)&&(this.where+=":"),"Edm.String"==s[0].value)if(this.options.useParameters){const e=odata_v4_literal_1.Literal.convert(s[0].value,s[0].raw);this.parameters.push(`%${e}%`),this.where+=" ILIKE :"+(this.parameters.length-1)}else this.where+=` ILIKE '%${visitor_1.SQLLiteral.convert(s[0].value,s[0].raw).slice(1,-1)}%'`;else this.where+=" ILIKE ",this.Visit(s[0],t);break;case"concat":this.where+="(",this.Visit(s[0],t),this.where+=" || ",this.Visit(s[1],t),this.where+=")";break;case"round":this.where+="ROUND(",this.Visit(s[0],t),this.where+=")";break;case"length":this.where+="CHAR_LENGTH(",this.Visit(s[0],t),this.where+=")";break;case"tolower":this.where+="LCASE(",this.Visit(s[0],t),this.where+=")";break;case"toupper":this.where+="UCASE(",this.Visit(s[0],t),this.where+=")";break;case"floor":case"ceiling":case"year":case"month":case"day":case"hour":case"minute":case"second":this.where+=i.toUpperCase()+"(",this.Visit(s[0],t),this.where+=")";break;case"now":this.where+="NOW()";break;case"trim":this.where+="TRIM(BOTH ' ' FROM ",this.Visit(s[0],t),this.where+=")"}}}exports.PGVisitor=PGVisitor;