"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const koa_router_1=__importDefault(require("koa-router")),koa_passport_1=__importDefault(require("koa-passport")),dataAccess_1=require("../db/dataAccess/"),_helpers_1=require("./_helpers"),constants_1=require("../constants"),db_1=require("../db"),views_1=require("./views"),router=new koa_router_1.default,emailIsValid=e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),checkPassword=e=>/^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])\w{6,}$/.test(e);router.get(["/register","/api/register"],async e=>{const t=new views_1.CreateHtml;e.type=constants_1.returnFormat[constants_1.formatsResult.HTML],e.body=t.login({login:!1})}),router.post(["/register","/api/register"],async(e,t)=>{const s=e.request.body,r="string"!=typeof s,a={};if(r&&""===s.username.trim())a.username="Empty username";else{await(0,db_1.db)("user").select("username").where({username:e.request.body.username}).first()&&(a.username="Already present")}var o,n;if(r&&""===s.email.trim()?a.email="Empty email":!1===(o=s.email,/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o))&&(a.email="Invalid email"),r&&""===s.password.trim()&&(a.password="Empty password"),r&&""===s.repeat.trim()?a.repeat="Empty repeat password":s.password!=s.repeat?a.repeat="Password are different":!1===(n=s.password,/^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])\w{6,}$/.test(n))&&(a.password="Invalid password"),0===Object.keys(a).length)try{return await dataAccess_1.userAccess.add(e.request.body),await koa_passport_1.default.authenticate("local",async(t,s,r,a)=>{s?(e.status=200,e.login(s),e.redirect("/status")):(e.status=400,e.redirect("/register"))})(e,t)}catch(t){e.redirect("/error")}else{const t=new views_1.CreateHtml;e.type=constants_1.returnFormat[constants_1.formatsResult.HTML],e.body=t.login({login:!1,body:e.request.body,why:a})}}),router.get(["/login","/api/login"],async e=>{if(_helpers_1.helperUsers.ensureAuthenticated(e))e.redirect("/status");else{const t=new views_1.CreateHtml;e.type=constants_1.returnFormat[constants_1.formatsResult.HTML],e.body=e.body=t.login({login:!0})}}),router.post(["/login","/api/login"],async(e,t)=>await koa_passport_1.default.authenticate("local",(t,s)=>{s?(e.login(s),e.redirect("/status")):(e.status=400,e.redirect("/login"))})(e,t)),router.get(["/logout","/api/logout"],async e=>{_helpers_1.helperUsers.ensureAuthenticated(e)?(e.logout(),e.session=null,e.redirect("/login")):(e.body={success:!1},e.throw(401))}),router.get(["/status","/api/status"],async e=>{if(_helpers_1.helperUsers.ensureAuthenticated(e)){const t=await dataAccess_1.userAccess.getSingle(e.state.user.id),s=new views_1.CreateHtml;e.type=constants_1.returnFormat[constants_1.formatsResult.HTML],e.body=s.status({username:t[0].username,host:process.env.PGHOST||"",database:process.env.PGDATABASE||"",admin:1==t[0].admin?"admin":"user"})}else e.redirect("/login")}),router.get(["/error","/api/error"],async e=>{const t=new views_1.CreateHtml;e.type=constants_1.returnFormat[constants_1.formatsResult.HTML],e.body=t.error("what ?")}),exports.default=router.routes();