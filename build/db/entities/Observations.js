"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Observations=void 0;const common_1=require("./common"),db_1=require("../../db"),index_1=require("../../utils/index"),constants_1=require("../../constants");class Observations extends common_1.Common{constructor(t,e,s,a){super(t,e,a)}async add(t){this.args.debug&&(0,index_1.message)("HEAD","class Observations add createObservation");const e=[];let s=0;if(!this.args.entities[0].startsWith("CreateObservations"))return await super.add(t);if(this.args.extras){const t=this.args.extras;if("Datastreams"==t.entity){this.args.debug&&(0,index_1.message)("INFO","addFromCsv");const a=JSON.parse(t.datas);a.columns||this.ctx.throw(404,{detail:"No columns parameters found"});const n=[],o=[],r=[];Object.keys(a.columns).forEach(t=>{const e=a.columns[t].featureOfInterest?a.columns[t].featureOfInterest:"1";n.push({column:t,datastream:a.columns[t].datastream,featureOfInterest:e}),o.push(BigInt(a.columns[t].datastream)),BigInt(e)>1&&r.push(BigInt(e))});const i={tempTable:"temp"+Date.now().toString(),filename:t.file,columns:n,header:a.header&&1==a.header?", HEADER":"",dataStreamId:BigInt(t.nb),debug:this.args.debug};await(0,index_1.verifyId)(common_1.Common.dbContext,o,constants_1._DBDATAS.Datastreams.table)||(this.args.debug&&(0,index_1.message)("INFO","test Datastream ID",o),this.ctx.throw(404,{detail:o.length>0?"No id found for : "+o:"One of id not found for : "+o}));await(0,index_1.verifyId)(common_1.Common.dbContext,r,constants_1._DBDATAS.FeaturesOfInterest.table)||(this.args.debug&&(0,index_1.message)("INFO","test FeatureOfInterest ID",r),this.ctx.throw(404,{detail:r.length>0?"No id found for : "+r:"One of id not found for : "+r}));const d=await(0,index_1.importCsv)(common_1.Common.dbContext,i);this.args.debug&&(0,index_1.message)("INFO","importCsv","OK"),s=d.length,d.forEach(t=>{e.push(this.linkBase+"("+t+")")})}}else{const s=[{}],a=t.Datastream["@iot.id"];await(0,index_1.verifyId)(common_1.Common.dbContext,BigInt(a),constants_1._DBDATAS.Datastreams.table)||this.ctx.throw(404,{detail:"No id found for : "+a}),t.dataArray.forEach(e=>{const n={datastream_id:Number(a)};t.components.forEach((t,s)=>{n[t]=e[s]}),s.push((0,index_1.renameProp)("FeatureOfInterest/id","featureofinterest_id",n))});try{const t=await db_1.db.table("observation").insert(s.filter(t=>Object.keys(t).length)).returning("*");t.map(t=>t.id).forEach(t=>{e.push(this.linkBase+"("+t+")")})}catch(t){t instanceof Error&&this.ctx.throw(400,{detail:t.message})}}return e?this.formatReturnResult({total:s,result:e}):void 0}}exports.Observations=Observations;