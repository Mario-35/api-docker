var jsonObj={},jsonViewer=new JSONViewer;document.querySelector("#json").appendChild(jsonViewer.getContainer()),listOperations=["GET","POST","PATCH","DELETE"],paramEntity="",paramSubentity="",paramId="",paramMethod="",paramUser="",paramOptions="",paramVersion="";const relations="@relations@";let importFile=!1;var notify=function(e,t){titre.innerHTML=e,corps.innerHTML=t,message.click()},goOrSubmit=function(){if(columnsInfos.style.display="none",1==importFile){go.style.display="none",columnsInfos.style.display="inline-block";const e=datas.value;Number(nb.value)>0||null!=e.match("columns")?submit.style.display="inline-block":submit.style.display="none"}else go.style.display="inline-block",submit.style.display="none"},wait=function(e){spinner.style.display=1==e?"inline-block":"none"},populateSelect=function(e,t,n,a){e.options.length=0,t&&(a&&t.unshift("none"),t.forEach(t=>{e.add(new Option(t))}),e.selectedIndex=t.indexOf(n))};submit.onclick=()=>{wait(!0)},buildTableWithCsv=(e,t)=>{json.style.display="none";var n=document.getElementById("two"),a=e.split(/\r?\n|\r/).filter(e=>""!==e),o=document.createElement("table");o.setAttribute("id","csv");for(var s=0;s<a.length;s++){_tr=document.createElement(0===s?"thead":"tr");const e=a[s].split(t);for(var i=0;i<e.length;i++){const t=document.createElement(0===s?"th":"td"),n=document.createTextNode(e[i].replace(/\"/g,""));t.appendChild(n),_tr.appendChild(t)}o.appendChild(_tr)}wait(!1);const l=document.getElementById("csv");l?n.replaceChild(o,l):n.appendChild(o)},go.onclick=async e=>{e.preventDefault(),wait(!0);const t=Number(nb.value);let n=document.URL.split("/Query")[0];n=`${n}${"/"==n[n.length-1]?"":"/"}${paramVersion}`;let a=options.value;if(""!=a&&"?"!=a[0]&&(a="?"+a),n=t>0?n+"/"+entity.value+"("+t+")":n+"/"+entity.value,"none"!=subentity.value?n=n+"/"+subentity.value+a:n+=a,"GET"===method.value){let e=await fetch(n,{method:"GET",headers:{"Content-Type":"application/json"}});try{var o=await e.text();a.includes("resultFormat=CSV")?buildTableWithCsv(o,";"):(jsonObj=JSON.parse(o),jsonViewer.showJSON(jsonObj),json.style.display="block")}catch(e){notify("Error",e.message)}}else if("POST"==method.value||"PATCH"==method.value)if("createDB"===entity.value){let e=await fetch(document.URL.split("/Query")[0]+(paramVersion+"/createDB"),{method:"POST",headers:{"Content-Type":"application/json"},body:datas.value});try{const t=await e.text();401==e.status&&(window.location.href="/login"),jsonObj=JSON.parse(t),jsonViewer.showJSON(jsonObj)}catch(e){fetch(document.URL.split("/Query")[0]+"/error",{method:"POST",headers:{"Content-Type":"application/json"},body:datas.value})}}else{let e=await fetch(n,{method:method.value,headers:{"Content-Type":"application/json"},body:datas.value});try{const t=await e.text();401==e.status&&(window.location.href="/login"),jsonObj=JSON.parse(t),jsonViewer.showJSON(jsonObj)}catch(e){fetch(document.URL.split("/Query")[0]+"/error",{method:"POST",headers:{"Content-Type":"application/json"},body:datas.value})}}else if("DELETE"===method.value&&t&&t>0){let e=await fetch(n,{method:"DELETE",headers:{"Content-Type":"application/json"}});try{jsonObj=204==e.status?{Delete:"Ok"}:{Delete:"Error"},jsonViewer.showJSON(jsonObj)}catch(e){window.location.href="/error"}}},preview.addEventListener("click",(function(){try{const e=datas.value;jsonObj=JSON.parse(e)}catch(e){notify("Error",e.message)}jsonViewer.showJSON(jsonObj)})),logout.onclick=()=>{window.location.href="/logout"},info.onclick=()=>{window.location.href="/status"},doc.onclick=()=>{window.location.href="http://sensorthings.geosas.fr/apidoc/"},git.onclick=()=>{window.location.href="https://github.com/Mario-35/api-sensorthing"},columnsInfos.onclick=()=>{notify("multi columns",'{<br> &nbsp;&nbsp;"header":true<br>, &nbsp;&nbsp;"nan":true<br>, &nbsp;&nbsp;"columns": {<br> &nbsp;&nbsp;&nbsp;&nbsp;"column Number": "Datastream ID",<br> &nbsp;&nbsp;&nbsp;&nbsp;"1": "1",<br> &nbsp;&nbsp;&nbsp;&nbsp;"2": "2",<br> &nbsp;&nbsp;&nbsp;&nbsp;"3": "6"<br> &nbsp;}<br> }<br>'),jsonObj=JSON.parse('{\n    "header": true,\n    "nan": true,\n    "columns": {\n      "1": "1",\n      "2": "2",\n      "3": "6"\n    }\n  }'),jsonViewer.showJSON(jsonObj)},nb.addEventListener("change",()=>{goOrSubmit()}),entity.addEventListener("change",()=>{subentity.options.length=0,["CreateObservations","createDB"].includes(entity.value)?method.value="POST":populateSelect(subentity,relations[entity.value],relations[tempEntity].includes(paramSubentity)?paramSubentity:"none",!0)}),fileone.addEventListener("change",e=>{var t="";try{(t=this.files&&this.files.length>1?(this.getAttribute("data-multiple-caption")||"").replace("{count}",this.files.length):e.target.value.split("\\").pop())?(fileonelabel.querySelector("span").innerHTML=t,method.value="POST",entity.value="Datastreams",subentity.value="Observations",importFile=!0):fileonelabel.innerHTML=labelVal}catch(e){notify("Error",e.message)}goOrSubmit()});var init=function(){new SplitterBar(container,first,two),wait(!1),history.replaceState({},null,"/Query"),source.style.display="none",source.value="query",tempEntity=Object.keys(relations).includes(paramEntity)?paramEntity:"Things",populateSelect(method,"true"==paramUser?listOperations:["GET"],"true"==paramUser&&listOperations.includes(paramMethod.toUpperCase())?paramMethod.toUpperCase():"GET"),populateSelect(entity,Object.keys(relations),tempEntity),populateSelect(subentity,relations[entity.value],relations[tempEntity].includes(paramSubentity)?paramSubentity:"none",!0),nb.value=paramId,options.value=paramOptions,options.value=options.value.replace(/\$/g,"&$"),"&"==options.value[0]&&(options.value=options.value.substring(1)),goOrSubmit();const e="true"==paramUser?"inline-block":"none";logout.style.display=e,fileone.style.display=e,fileonelabel.style.display=e};init();